name: ðŸš€ Sync GitHub Action Versions

on:
  schedule:
    - cron: "0 0 1,6,11,16,21,26 * *"
  workflow_dispatch:

env:
  JSON_FILE_PATH: ${{ github.workspace }}/data/actions-versions.json
  DATA_CENTER_FILE: ${{ github.workspace }}/data/data.json
  DATA_CENTER_NAME: actions-versions
  GITHUB_REPOS: '["actions/checkout", "actions/setup-node", "actions/setup-python", "actions/setup-dotnet", "actions/setup-java", "actions/cache", "actions/upload-artifact", "actions/download-artifact", "codecov/codecov-action", "dorny/test-reporter", "super-linter/super-linter", "sonarsource/sonarqube-scan-action", "aquasecurity/trivy-action", "actions/deploy-pages", "JamesIves/github-pages-deploy-action", "docker/login-action", "docker/setup-buildx-action", "docker/build-push-action", "google-github-actions/deploy-appengine", "azure/webapps-deploy", "aws-actions/configure-aws-credentials", "aws-actions/aws-cloudformation-github-deploy", "appleboy/ssh-action", "slackapi/slack-github-action", "actions/github-script", "actions/labeler", "actions/stale", "actions/create-release", "softprops/action-gh-release", "dephraiim/translate-readme", "subosito/flutter-action"]'
  REQUESTS_PER_REPO: 2
  UNAUTHENTICATED_REQUESTS_MAX: 60
  MAX_JOBS: 20
  MAX_API_REQUESTS: 500
  ISSUE_ID: 1

jobs:
  split:
    name: ðŸ” Prepare Repository List
    runs-on: ubuntu-latest
    outputs:
      GITHUB_REPOS_LIST: ${{ steps.split.outputs.GITHUB_REPOS_LIST }}
    steps:
      - name: ðŸ“‹ Check Limits and Split Repositories
        uses: actions/github-script@v6
        id: split
        env:
          OWNER: ${{ github.repository_owner }}
          REPO: ${{ github.repository }}
        with:
          script: |
            const OWNER = process.env.OWNER;
            const REPO = process.env.REPO.replace(`${OWNER}/`, "");
            const MAX_API_REQUESTS = parseInt(process.env.MAX_API_REQUESTS);
            const REQUESTS_PER_REPO = parseInt(process.env.REQUESTS_PER_REPO);
            const MAX_GITHUB_REPOS = Math.floor(MAX_API_REQUESTS / REQUESTS_PER_REPO);
            const GITHUB_REPOS = JSON.parse(process.env.GITHUB_REPOS);

            if (GITHUB_REPOS.length > MAX_GITHUB_REPOS) {
              await github.rest.issues.createComment({
                owner: OWNER,
                repo: REPO,
                issue_number: process.env.ISSUE_ID,
                body: `### âš ï¸ Warning: Too many repositories being monitored (${GITHUB_REPOS.length} > ${MAX_GITHUB_REPOS}).`,
              })
              throw new Error(`Too many repositories being monitored (${GITHUB_REPOS.length} > ${MAX_GITHUB_REPOS}).`);
            }

            const MAX_JOBS = parseInt(process.env.MAX_JOBS);
            const UNAUTHENTICATED_REQUESTS_MAX = parseInt(process.env.UNAUTHENTICATED_REQUESTS_MAX);
            const JOB_MAX_GITHUB_REPOS = Math.floor(UNAUTHENTICATED_REQUESTS_MAX / REQUESTS_PER_REPO) - 1;
            const NEED_JOBS = Math.ceil(GITHUB_REPOS.length / JOB_MAX_GITHUB_REPOS);

            if (NEED_JOBS > MAX_JOBS) {
              await github.rest.issues.createComment({
                owner: OWNER,
                repo: REPO,
                issue_number: process.env.ISSUE_ID,
                body: `### âš ï¸ Warning: Too many jobs required (${NEED_JOBS} > ${MAX_JOBS}).`,
              })
              throw new Error(`Too many jobs required (${NEED_JOBS} > ${MAX_JOBS}).`);
            }

            const GITHUB_REPOS_LIST = []
            for (let i = 0; i < NEED_JOBS; i++) {
              GITHUB_REPOS_LIST.push({
                index: i,
                repos: GITHUB_REPOS.slice(i * JOB_MAX_GITHUB_REPOS, (i + 1) * JOB_MAX_GITHUB_REPOS)
              })
            }
            core.setOutput('GITHUB_REPOS_LIST', JSON.stringify(GITHUB_REPOS_LIST))

  generate:
    name: âš™ï¸ Generate Versions JSON
    needs: [split]
    strategy:
      max-parallel: 1
      matrix:
        job_config: ${{ fromJSON(needs.split.outputs.GITHUB_REPOS_LIST) }}
    runs-on: ubuntu-latest
    env:
      GITHUB_REPOS: ${{ toJson(matrix.job_config.repos) }}

    steps:
      - name: ðŸ“¥ Checkout Repository
        uses: actions/checkout@v4
      
      - name: ðŸ”„ Pull Latest Changes
        run: git pull --rebase

      - name: ðŸŸ¢ Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "22"

      - name: ðŸ“¦ Install Dependencies
        run: npm install axios

      - name: ðŸš€ Run Collection Script
        run: node scripts/collect-action-versions.js

      - name: ðŸ“¤ Commit and Push Changes
        run: |
          git config --global user.name "GitHub Actions"
          git config --global user.email "actions@github.com"
          git add ${{ env.JSON_FILE_PATH }}
          git commit -m "chore: auto-generated versions JSON [skip ci]" || echo "No version changes"
          git add ${{ env.DATA_CENTER_FILE }}
          git commit -m "chore: update data center [skip ci]" || echo "No data center changes"
          git push
